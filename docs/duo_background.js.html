<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>JSDoc: Source: duo_background.js</title>

	<script src="scripts/prettify/prettify.js"></script>
	<script src="scripts/prettify/lang-css.js"></script>
	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link href="styles/prettify-tomorrow.css" rel="stylesheet" type="text/css">
	<link href="styles/jsdoc-default.css" rel="stylesheet" type="text/css">
</head>

<body>

<div id="main">

	<h1 class="page-title">Source: duo_background.js</h1>


	<section>
		<article>
            <pre class="prettyprint source linenums"><code>/**
 * duo_background.js
 *
 * @file Background listener and function executor for bypassing the RIT MyCourses authentication system.
 * @author Nicholas Valletta (Inchworm333) &lt;inchworm333@gmail.com>
 * @version 1.0.0
 */

//Constants
const duo_url = 'https://start.rit.edu/Shibboleth.sso/Login?authnContextClassRef=' +
	'http://rit.edu/ac/classes/mfa&amp;target=https://start.rit.edu/Duo/createOfflineCodes';

let needsNewCodes = false;

/**
 * Listens for messages about duo authentication such as getting/storing/updating passcodes.
 *
 * @listens chrome.runtime.onMessage
 */
chrome.runtime.onMessage.addListener((message) => {
	if (message.whatDo === "getPasscodes") {
		console.log('bg: set needsNewCodes to true');
		needsNewCodes = true;
	} else if (message.whatDo === "storePasscodes") {
		console.log('bg: storing passcodes')
		store_passcodes(message.passcodes, message.exp);
	} else if (message.whatDo === "updatePasscodes") {
		console.log('updating used passcodes')
		update_passcodes(message.passcodes);
	} else if (message.whatDo === "pageLoad") {
		console.log('page loaded');
		if (needsNewCodes) {
			passcode_page();
		}
	}
})

/**
 * Creates minimized window that creates new passcodes
 *
 * @see duo_url
 */
function passcode_page() {
	chrome.windows.create({url: duo_url, type: 'popup', state: 'minimized', setSelfAsOpener: true});
}

/**
 * Stores the passcodes and passcode expiration date
 *
 * @param {int[]} passcodes - the list of passcodes
 * @param {Date} expiration - the date the passcodes expire
 */
function store_passcodes(passcodes, expiration) {
	passcodes = passcodes.map(passcode => {
		return {"code": passcode, "used": false}
	})
	//TODO: implement check for local or sync storage choice
	chrome.storage.local.set({loginPasscodes: passcodes, passcodeExp: expiration}, () => {
		console.log(`Stored passcodes:`);
		console.log(passcodes);
	})
}

/**
 * Updates the passcodes
 *
 * @see store_passcodes
 *
 * @param {Object} passcodes
 */
function update_passcodes(passcodes) {
	//TODO: implement check for local or sync storage choice
	chrome.storage.local.set({loginPasscodes: passcodes}, () => {
		console.log(`Updated passcodes:`);
		console.log(passcodes);
	})
}</code></pre>
		</article>
	</section>


</div>

<nav>
	<h2><a href="index.html">Home</a></h2>
	<h3>Global</h3>
	<ul>
		<li><a href="global.html#input_login">input_login</a></li>
		<li><a href="global.html#login">login</a></li>
		<li><a href="global.html#passcode_page">passcode_page</a></li>
		<li><a href="global.html#store_passcodes">store_passcodes</a></li>
		<li><a href="global.html#update_passcodes">update_passcodes</a></li>
	</ul>
</nav>

<br class="clear">

<footer>
	Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.6</a> on Sat Nov 14 2020 03:29:12
	GMT-0500 (Eastern Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
